{% comment %}
  Renders a megamenu for "Shop By Artist" collections.
{% endcomment %}

{%- liquid
  assign by_artist = section.settings.custom_artists_title
  if by_artist == blank
    assign by_artist = 'sections.header.custom_menu.by_artist' | t
  endif
-%}

<li class="hoverable">
  <button
    id="dropdown-hover-artists"
    type="button"
    class="header__menu-item list-menu__item link focus-inset"
    aria-haspopup="true"
    aria-expanded="false"
  >
    <span class="custom-menu-caret">
      {{ by_artist }}
      {% render 'icon-caret' %}
    </span>
  </button>
  <div class="custom-menu custom-menu-padding">
    <div class="custom-menu-container">
      <div class="custom-menu-left">
        <ul id="artists-menu" class="custom-menu-column">
          <div class="custom-menu-item">
            <h3 class="custom-menu-title">{{ by_artist }}</h3>
          </div>
          <div class="custom-menu-list">
            {%- assign artist_count = 0 -%}
            {%- for collection in collections -%}
              {%- if collection.metafields.collection.is_nav == true
                and collection.metafields.collection.by_artist == true
              -%}
                {%- assign artist_count = artist_count | plus: 1 -%}
                <div class="custom-menu-item">
                  <a
                    href="{{ collection.url }}"
                    class="custom-menu-link{% if collection.current %} menu-drawer__menu-item--active{% endif %}"
                    {% if collection.current %}
                      aria-current="page"
                    {% endif %}
                  >
                    {{ collection.title | escape }}
                  </a>
                </div>
              {%- endif -%}
            {%- endfor -%}
            <a
              href="{{ section.settings.artists_view_all_url | default: '/collections/artists' }}"
              class="custom-menu-cta"
            >
              {{ section.settings.artists_view_all_label | default: 'View All Artists' }}
              <span class="custom-menu-cta-count">+</span>
            </a>
          </div>
        </ul>
      </div>
      <div class="custom-menu-right">
        <ul id="artists-featured" class="collection-list grid grid--2-col" role="list">
          {%- assign featured_count = 0 -%}
          {%- for collection in collections -%}
            {%- if collection.metafields.collection.is_nav == true
              and collection.metafields.collection.is_featured == true
            -%}
              <li class="collection-list__item grid__item">
                {% render 'card-collection',
                  card_collection: collection,
                  media_aspect_ratio: section.settings.image_ratio
                %}
              </li>
              {%- assign featured_count = featured_count | plus: 1 -%}
            {%- endif -%}
          {%- endfor -%}

          {%- if featured_count == 0 -%}
            {%- assign shown = 0 -%}
            {%- for collection in collections -%}
              {%- if collection.metafields.collection.is_nav == true and collection.image -%}
                <li class="collection-list__item grid__item">
                  {% render 'card-collection',
                    card_collection: collection,
                    media_aspect_ratio: section.settings.image_ratio
                  %}
                </li>
                {%- assign shown = shown | plus: 1 -%}
                {%- if shown == 2 -%}{% break %}{%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        </ul>
      </div>
    </div>
  </div>
</li>

<script>
  (function () {
    if (window.__customMenuOverflowInit) return;
    window.__customMenuOverflowInit = true;

    function updateOverflow(container) {
      if (!container) return;
      container.querySelectorAll('.custom-menu-list').forEach(function (listEl) {
        var hasOverflow = listEl.scrollHeight > listEl.clientHeight;
        listEl.classList.toggle('has-overflow', !!hasOverflow);
      });
    }

    document.querySelectorAll('.hoverable').forEach(function (hoverEl) {
      hoverEl.addEventListener('mouseenter', function () {
        var menu = hoverEl.querySelector('.custom-menu');
        if (!menu) return;
        requestAnimationFrame(function () {
          updateOverflow(menu);
        });
      });
    });

    window.addEventListener('resize', function () {
      document.querySelectorAll('.custom-menu').forEach(updateOverflow);
    });
  })();
</script>
